{% extends "base.html" %}

{% block title %}Dashboard - Mini Video Factory{% endblock %}

{% block extra_css %}
<style>
    .upload-section {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 2rem;
        margin-bottom: 2rem;
        border: 2px dashed #dee2e6;
        transition: border-color 0.3s;
    }

    .upload-section.dragover {
        border-color: #667eea;
        background: #f0f4ff;
    }

    .upload-area {
        text-align: center;
        padding: 2rem;
    }

    .file-input-wrapper {
        position: relative;
        display: inline-block;
        margin: 1rem 0;
    }

    .file-input {
        position: absolute;
        opacity: 0;
        width: 100%;
        height: 100%;
        cursor: pointer;
    }

    .file-input-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1rem 2rem;
        border: none;
        border-radius: 8px;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s;
    }

    .file-input-btn:hover {
        transform: translateY(-2px);
    }

    .upload-info {
        margin-top: 1rem;
        color: #666;
        font-size: 0.9rem;
    }

    .progress-section {
        display: none;
        margin-top: 2rem;
    }

    .progress-bar {
        width: 100%;
        height: 20px;
        background: #e9ecef;
        border-radius: 10px;
        overflow: hidden;
        margin: 1rem 0;
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        width: 0%;
        transition: width 0.3s ease;
    }

    .progress-text {
        text-align: center;
        margin: 0.5rem 0;
        font-weight: 600;
    }

    .jobs-section {
        margin-top: 2rem;
    }

    .job-item {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .job-info {
        flex-grow: 1;
    }

    .job-status {
        padding: 0.25rem 0.75rem;
        border-radius: 15px;
        font-size: 0.8rem;
        font-weight: 600;
    }

    .status-completed {
        background: #d4edda;
        color: #155724;
    }

    .status-failed {
        background: #f8d7da;
        color: #721c24;
    }

    .status-processing {
        background: #fff3cd;
        color: #856404;
    }

    .error-message {
        background: #f8d7da;
        color: #721c24;
        padding: 1rem;
        border-radius: 8px;
        margin: 1rem 0;
        display: none;
    }

    .success-message {
        background: #d4edda;
        color: #155724;
        padding: 1rem;
        border-radius: 8px;
        margin: 1rem 0;
        display: none;
    }

    .btn {
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 5px;
        text-decoration: none;
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        transition: background-color 0.2s;
        display: inline-block;
        text-align: center;
    }

    .btn-primary {
        background: #667eea;
        color: white;
    }

    .btn-primary:hover {
        background: #5a6fd8;
    }

    .btn-success {
        background: #28a745;
        color: white;
    }

    .btn-success:hover {
        background: #218838;
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="header">
        <div>
            <h1>üé¨ Mini Video Factory</h1>
            <p style="color: #666;">Welcome back, {{ user.username }}!</p>
        </div>
        <a href="{{ url_for('logout') }}" class="logout-btn">Logout</a>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <div class="flash-messages">
        {% for category, message in messages %}
        <div class="flash-message flash-{{ category }}">
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}
    {% endwith %}

    <!-- Upload Section -->
    <div class="upload-section" id="uploadSection">
        <div class="upload-area">
            <h3 style="margin-bottom: 1rem; color: #333;">Upload Video for Processing</h3>
            <p style="color: #666; margin-bottom: 1.5rem;">
                Drop your video file here or click to browse
            </p>

            <form id="uploadForm" enctype="multipart/form-data">
                <div class="file-input-wrapper">
                    <input type="file" id="videoFile" name="video_file" class="file-input"
                        accept=".mp4,.avi,.mov,.mpeg,.mpg,.wmv" required>
                    <button type="button" class="file-input-btn">
                        üìÅ Choose Video File
                    </button>
                </div>
            </form>

            <div class="upload-info">
                <p><strong>Supported formats:</strong> MP4, AVI, MOV, MPEG, WMV</p>
                <p><strong>Maximum size:</strong> 100MB | <strong>Maximum duration:</strong> 10 minutes</p>
            </div>
        </div>

        <!-- Progress Section -->
        <div class="progress-section" id="progressSection">
            <div class="progress-text" id="progressText">Uploading...</div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div id="progressPercent" style="text-align: center; font-size: 0.9rem; color: #666;">0%</div>
        </div>

        <!-- Messages -->
        <div class="error-message" id="errorMessage"></div>
        <div class="success-message" id="successMessage"></div>
    </div>

    <!-- Jobs Section -->
    <div class="jobs-section">
        <h3 style="margin-bottom: 1rem; color: #333;">Your Processing Jobs</h3>
        <div id="jobsList">
            <p style="color: #666; text-align: center; padding: 2rem;">
                No processing jobs yet. Upload a video to get started!
            </p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const uploadSection = document.getElementById('uploadSection');
        const uploadForm = document.getElementById('uploadForm');
        const videoFile = document.getElementById('videoFile');
        const progressSection = document.getElementById('progressSection');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const progressPercent = document.getElementById('progressPercent');
        const errorMessage = document.getElementById('errorMessage');
        const successMessage = document.getElementById('successMessage');
        const jobsList = document.getElementById('jobsList');

        let currentJobId = null;
        let progressInterval = null;

        // Load existing jobs on page load
        loadUserJobs();

        // Drag and drop functionality
        uploadSection.addEventListener('dragover', function (e) {
            e.preventDefault();
            uploadSection.classList.add('dragover');
        });

        uploadSection.addEventListener('dragleave', function (e) {
            e.preventDefault();
            uploadSection.classList.remove('dragover');
        });

        uploadSection.addEventListener('drop', function (e) {
            e.preventDefault();
            uploadSection.classList.remove('dragover');

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                videoFile.files = files;
                handleFileUpload();
            }
        });

        // File input change
        videoFile.addEventListener('change', function () {
            if (this.files.length > 0) {
                handleFileUpload();
            }
        });

        function handleFileUpload() {
            const file = videoFile.files[0];
            if (!file) return;

            // Reset UI
            hideMessages();
            showProgress();
            updateProgress(0, 'Preparing upload...');

            // Create form data
            const formData = new FormData();
            formData.append('video_file', file);

            // Upload file
            fetch('/upload', {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        currentJobId = data.job_id;
                        showSuccess('File uploaded successfully! Processing will begin shortly.');
                        startProgressTracking();
                        loadUserJobs(); // Refresh jobs list
                    } else {
                        showError(data.error || 'Upload failed');
                        hideProgress();
                    }
                })
                .catch(error => {
                    console.error('Upload error:', error);
                    showError('Upload failed. Please try again.');
                    hideProgress();
                });
        }

        function startProgressTracking() {
            if (!currentJobId) return;

            progressInterval = setInterval(() => {
                fetch(`/upload_progress/${currentJobId}`)
                    .then(response => response.json())
                    .then(data => {
                        updateProgress(data.progress, data.status_display);

                        if (data.completed) {
                            clearInterval(progressInterval);
                            progressInterval = null;

                            if (data.error_message) {
                                showError(`Processing failed: ${data.error_message}`);
                            } else {
                                showSuccess('Video processing completed successfully!');
                            }

                            setTimeout(() => {
                                hideProgress();
                                loadUserJobs();
                            }, 3000);
                        }
                    })
                    .catch(error => {
                        console.error('Progress tracking error:', error);
                        clearInterval(progressInterval);
                        progressInterval = null;
                    });
            }, 2000); // Check every 2 seconds
        }

        function updateProgress(percent, status) {
            progressFill.style.width = percent + '%';
            progressPercent.textContent = percent + '%';
            progressText.textContent = status;
        }

        function showProgress() {
            progressSection.style.display = 'block';
        }

        function hideProgress() {
            progressSection.style.display = 'none';
            videoFile.value = ''; // Reset file input
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            successMessage.style.display = 'none';
        }

        function showSuccess(message) {
            successMessage.textContent = message;
            successMessage.style.display = 'block';
            errorMessage.style.display = 'none';
        }

        function hideMessages() {
            errorMessage.style.display = 'none';
            successMessage.style.display = 'none';
        }

        function loadUserJobs() {
            fetch('/user_jobs')
                .then(response => response.json())
                .then(data => {
                    displayJobs(data.jobs);
                })
                .catch(error => {
                    console.error('Error loading jobs:', error);
                });
        }

        function displayJobs(jobs) {
            if (jobs.length === 0) {
                jobsList.innerHTML = '<p style="color: #666; text-align: center; padding: 2rem;">No processing jobs yet. Upload a video to get started!</p>';
                return;
            }

            const jobsHtml = jobs.map(job => {
                const statusClass = getStatusClass(job.status);
                const createdAt = new Date(job.created_at).toLocaleString();

                let actionButton = '';
                if (job.status === 'uploaded') {
                    actionButton = `<button onclick="startProcessing('${job.id}')" class="btn btn-primary" style="margin-left: 1rem;">Start Processing</button>`;
                } else if (job.status === 'completed') {
                    actionButton = `
                    <a href="/preview/${job.id}" class="btn btn-primary" style="margin-left: 0.5rem;">üëÅÔ∏è Preview</a>
                    <a href="/download/${job.id}" class="btn btn-success" style="margin-left: 0.5rem;">üì• Download</a>
                `;
                } else if (job.status === 'failed') {
                    actionButton = `<button onclick="retryJob('${job.id}')" class="btn btn-warning" style="margin-left: 1rem; background-color: #ffc107; color: #212529;">üîÑ Retry</button>`;
                }

                return `
                <div class="job-item">
                    <div class="job-info">
                        <div style="font-weight: 600; margin-bottom: 0.25rem;">${job.original_filename}</div>
                        <div style="font-size: 0.9rem; color: #666;">
                            Created: ${createdAt}
                            ${job.video_info ? ` | Duration: ${Math.round(job.video_info.duration)}s` : ''}
                            ${job.progress > 0 ? ` | Progress: ${job.progress}%` : ''}
                            ${job.status === 'completed' && job.processed_video_info ? ` | Processed: ${Math.round(job.processed_video_info.duration)}s` : ''}
                        </div>
                        ${job.error_message ? `<div style="color: #dc3545; font-size: 0.8rem; margin-top: 0.25rem;">${job.error_message}</div>` : ''}
                    </div>
                    <div style="display: flex; align-items: center;">
                        <div class="job-status ${statusClass}">
                            ${job.status.replace('_', ' ').toUpperCase()}
                        </div>
                        ${actionButton}
                    </div>
                </div>
            `;
            }).join('');

            jobsList.innerHTML = jobsHtml;
        }

        function getStatusClass(status) {
            switch (status) {
                case 'completed':
                    return 'status-completed';
                case 'failed':
                    return 'status-failed';
                default:
                    return 'status-processing';
            }
        }

        // Global function to start processing
        window.startProcessing = function (jobId) {
            if (confirm('Start processing this video? This may take several minutes.')) {
                showSuccess('Starting video processing...');

                fetch(`/process_video/${jobId}`, {
                    method: 'POST'
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showSuccess('Video processing completed successfully!');
                        } else {
                            showError(data.error || 'Processing failed');
                        }
                        loadUserJobs(); // Refresh jobs list
                    })
                    .catch(error => {
                        console.error('Processing error:', error);
                        showError('Processing failed. Please try again.');
                    });
            }
        };

        // Global function to retry processing
        window.retryJob = function (jobId) {
            if (confirm('Retry processing this video? It will attempt to reuse existing resources.')) {
                showSuccess('Retrying video processing...');

                fetch(`/retry_job/${jobId}`, {
                    method: 'POST'
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showSuccess('Job retry completed successfully!');
                        } else {
                            showError(data.error || 'Retry failed');
                        }
                        loadUserJobs(); // Refresh jobs list
                    })
                    .catch(error => {
                        console.error('Retry error:', error);
                        showError('Retry failed. Please try again.');
                    });
            }
        };
    });
</script>
{% endblock %}