{% extends "base.html" %}

{% block title %}Video Preview - Mini Video Factory{% endblock %}

{% block extra_css %}
<style>
    .preview-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem;
    }
    
    .video-section {
        background: white;
        border-radius: 10px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .video-player {
        width: 100%;
        max-width: 800px;
        margin: 0 auto;
        display: block;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        background: #000;
    }
    
    .video-player:focus {
        outline: 2px solid #667eea;
        outline-offset: 2px;
    }
    
    .video-info {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1.5rem;
        margin-top: 2rem;
    }
    
    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
    }
    
    .info-item {
        display: flex;
        justify-content: space-between;
        padding: 0.5rem 0;
        border-bottom: 1px solid #dee2e6;
    }
    
    .info-label {
        font-weight: 600;
        color: #495057;
    }
    
    .info-value {
        color: #6c757d;
    }
    
    .actions-section {
        background: white;
        border-radius: 10px;
        padding: 2rem;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        text-align: center;
    }
    
    .btn {
        padding: 0.75rem 2rem;
        border: none;
        border-radius: 8px;
        text-decoration: none;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        display: inline-block;
        margin: 0 0.5rem;
    }
    
    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }
    
    .btn-success {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
    }
    
    .btn-success:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);
    }
    
    .btn-secondary {
        background: #6c757d;
        color: white;
    }
    
    .btn-secondary:hover {
        background: #5a6268;
        transform: translateY(-2px);
    }
    
    .download-progress {
        display: none;
        margin-top: 1rem;
        text-align: center;
    }
    
    .progress-bar {
        width: 100%;
        max-width: 400px;
        height: 20px;
        background: #e9ecef;
        border-radius: 10px;
        overflow: hidden;
        margin: 1rem auto;
    }
    
    .progress-fill {
        height: 100%;
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        width: 0%;
        transition: width 0.3s ease;
    }
    
    .error-message {
        background: #f8d7da;
        color: #721c24;
        padding: 1rem;
        border-radius: 8px;
        margin: 1rem 0;
        display: none;
    }
    
    .success-message {
        background: #d4edda;
        color: #155724;
        padding: 1rem;
        border-radius: 8px;
        margin: 1rem 0;
        display: none;
    }
    
    .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid #e9ecef;
    }
    
    .back-btn {
        background: #6c757d;
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 5px;
        text-decoration: none;
        font-weight: 600;
        transition: background-color 0.2s;
    }
    
    .back-btn:hover {
        background: #5a6268;
        color: white;
        text-decoration: none;
    }
    
    .video-controls {
        margin-top: 1rem;
        text-align: center;
        color: #6c757d;
        font-size: 0.9rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="preview-container">
    <div class="header">
        <div>
            <h1>üé¨ Video Preview</h1>
            <p style="color: #666;">{{ job.original_filename }}</p>
        </div>
        <a href="{{ url_for('dashboard') }}" class="back-btn">‚Üê Back to Dashboard</a>
    </div>
    
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="flash-messages">
                {% for category, message in messages %}
                    <div class="flash-message flash-{{ category }}">
                        {{ message }}
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}
    
    <!-- Video Player Section -->
    <div class="video-section">
        <h3 style="margin-bottom: 1.5rem; text-align: center; color: #333;">Processed Video with Subtitles</h3>
        
        <video 
            class="video-player" 
            controls 
            preload="metadata"
            id="videoPlayer"
        >
            <source src="{{ url_for('stream_video', job_id=job.id) }}" type="video/mp4">
            Your browser does not support the video tag.
        </video>
        
        <div class="video-controls">
            <p>üìπ Video includes embedded subtitles and auto-edited content</p>
            <p>üí° Use the video controls to play, pause, adjust volume, and enable fullscreen</p>
        </div>
        
        <!-- Video Information -->
        <div class="video-info">
            <h4 style="margin-bottom: 1rem; color: #333;">Processing Information</h4>
            <div class="info-grid">
                <div class="info-item">
                    <span class="info-label">Original Filename:</span>
                    <span class="info-value">{{ job.original_filename }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Processing Status:</span>
                    <span class="info-value" style="color: #28a745; font-weight: 600;">{{ job.get_status_display() }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Created:</span>
                    <span class="info-value">{{ job.created_at.strftime('%Y-%m-%d %H:%M:%S') if job.created_at else 'Unknown' }}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Completed:</span>
                    <span class="info-value">{{ job.completed_at.strftime('%Y-%m-%d %H:%M:%S') if job.completed_at else 'Unknown' }}</span>
                </div>
                {% if job.video_info %}
                    {% if job.video_info.duration %}
                    <div class="info-item">
                        <span class="info-label">Original Duration:</span>
                        <span class="info-value">{{ "%.1f"|format(job.video_info.duration) }} seconds</span>
                    </div>
                    {% endif %}
                    {% if job.video_info.size %}
                    <div class="info-item">
                        <span class="info-label">Original Size:</span>
                        <span class="info-value">{{ "%.1f"|format(job.video_info.size / 1024 / 1024) }} MB</span>
                    </div>
                    {% endif %}
                    {% if job.video_info.format %}
                    <div class="info-item">
                        <span class="info-label">Original Format:</span>
                        <span class="info-value">{{ job.video_info.format.upper() }}</span>
                    </div>
                    {% endif %}
                {% endif %}
                {% if job.processed_video_info %}
                    {% if job.processed_video_info.duration %}
                    <div class="info-item">
                        <span class="info-label">Processed Duration:</span>
                        <span class="info-value">{{ "%.1f"|format(job.processed_video_info.duration) }} seconds</span>
                    </div>
                    {% endif %}
                    {% if job.processed_video_info.size %}
                    <div class="info-item">
                        <span class="info-label">Processed Size:</span>
                        <span class="info-value">{{ "%.1f"|format(job.processed_video_info.size / 1024 / 1024) }} MB</span>
                    </div>
                    {% endif %}
                    {% if job.get_time_saved_seconds() %}
                    <div class="info-item">
                        <span class="info-label">Time Saved:</span>
                        <span class="info-value" style="color: #28a745; font-weight: 600;">{{ "%.1f"|format(job.get_time_saved_seconds()) }} seconds</span>
                    </div>
                    {% endif %}
                    {% if job.get_compression_ratio() %}
                    <div class="info-item">
                        <span class="info-label">Size Reduction:</span>
                        <span class="info-value" style="color: #28a745; font-weight: 600;">{{ "%.1f"|format((1 - job.get_compression_ratio()) * 100) }}%</span>
                    </div>
                    {% endif %}
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Actions Section -->
    <div class="actions-section">
        <h3 style="margin-bottom: 1.5rem; color: #333;">Actions</h3>
        
        <div style="margin-bottom: 1rem;">
            <button onclick="downloadVideo()" class="btn btn-success" id="downloadBtn">
                üì• Download Processed Video
            </button>
            <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">
                üè† Back to Dashboard
            </a>
        </div>
        
        <!-- Download Progress -->
        <div class="download-progress" id="downloadProgress">
            <div style="margin-bottom: 0.5rem; font-weight: 600;">Preparing download...</div>
            <div class="progress-bar">
                <div class="progress-fill" id="downloadProgressFill"></div>
            </div>
            <div id="downloadProgressText">0%</div>
        </div>
        
        <!-- Messages -->
        <div class="error-message" id="errorMessage"></div>
        <div class="success-message" id="successMessage"></div>
        
        <div style="margin-top: 2rem; color: #6c757d; font-size: 0.9rem;">
            <p>üí° The processed video includes:</p>
            <ul style="list-style: none; padding: 0; margin: 0.5rem 0;">
                <li>‚úÖ Automatic removal of silent segments</li>
                <li>‚úÖ Embedded subtitles generated by AI</li>
                <li>‚úÖ Optimized MP4 format for compatibility</li>
            </ul>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const videoPlayer = document.getElementById('videoPlayer');
    const downloadBtn = document.getElementById('downloadBtn');
    const downloadProgress = document.getElementById('downloadProgress');
    const downloadProgressFill = document.getElementById('downloadProgressFill');
    const downloadProgressText = document.getElementById('downloadProgressText');
    const errorMessage = document.getElementById('errorMessage');
    const successMessage = document.getElementById('successMessage');
    
    const jobId = '{{ job.id }}';
    
    // Video player event handlers
    videoPlayer.addEventListener('loadstart', function() {
        console.log('Video loading started');
    });
    
    videoPlayer.addEventListener('loadedmetadata', function() {
        console.log('Video metadata loaded');
        console.log('Duration:', videoPlayer.duration);
    });
    
    videoPlayer.addEventListener('error', function(e) {
        console.error('Video error:', e);
        showError('Failed to load video. Please try refreshing the page.');
    });
    
    // Download functionality
    window.downloadVideo = function() {
        downloadBtn.disabled = true;
        downloadBtn.textContent = 'Preparing Download...';
        showDownloadProgress();
        
        // Check download readiness
        fetch(`/download_progress/${jobId}`)
        .then(response => response.json())
        .then(data => {
            if (data.download_ready) {
                // Simulate progress for user feedback
                simulateDownloadProgress();
                
                // Start actual download
                setTimeout(() => {
                    window.location.href = `/download/${jobId}`;
                    
                    // Reset UI after download starts
                    setTimeout(() => {
                        hideDownloadProgress();
                        downloadBtn.disabled = false;
                        downloadBtn.textContent = 'üì• Download Processed Video';
                        showSuccess('Download started! Check your browser downloads.');
                    }, 2000);
                }, 1000);
            } else {
                showError('Download not ready. Please try again.');
                resetDownloadButton();
            }
        })
        .catch(error => {
            console.error('Download preparation error:', error);
            showError('Failed to prepare download. Please try again.');
            resetDownloadButton();
        });
    };
    
    function simulateDownloadProgress() {
        let progress = 0;
        const interval = setInterval(() => {
            progress += Math.random() * 20;
            if (progress >= 100) {
                progress = 100;
                clearInterval(interval);
            }
            
            downloadProgressFill.style.width = progress + '%';
            downloadProgressText.textContent = Math.round(progress) + '%';
            
            if (progress < 30) {
                downloadProgressText.textContent = 'Preparing download...';
            } else if (progress < 70) {
                downloadProgressText.textContent = 'Generating download link...';
            } else if (progress < 100) {
                downloadProgressText.textContent = 'Starting download...';
            } else {
                downloadProgressText.textContent = 'Download ready!';
            }
        }, 200);
    }
    
    function showDownloadProgress() {
        downloadProgress.style.display = 'block';
        downloadProgressFill.style.width = '0%';
        downloadProgressText.textContent = '0%';
    }
    
    function hideDownloadProgress() {
        downloadProgress.style.display = 'none';
    }
    
    function resetDownloadButton() {
        downloadBtn.disabled = false;
        downloadBtn.textContent = 'üì• Download Processed Video';
        hideDownloadProgress();
    }
    
    function showError(message) {
        errorMessage.textContent = message;
        errorMessage.style.display = 'block';
        successMessage.style.display = 'none';
    }
    
    function showSuccess(message) {
        successMessage.textContent = message;
        successMessage.style.display = 'block';
        errorMessage.style.display = 'none';
    }
    
    function hideMessages() {
        errorMessage.style.display = 'none';
        successMessage.style.display = 'none';
    }
    
    // Auto-hide messages after 5 seconds
    setTimeout(() => {
        hideMessages();
    }, 5000);
});
</script>
{% endblock %}