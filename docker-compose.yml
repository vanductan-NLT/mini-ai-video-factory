version: '3.8'

services:
  mini-video-factory:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: mini-video-factory
    restart: unless-stopped
    
    # Environment configuration
    env_file:
      - .env
    
    environment:
      # Override specific settings for Docker deployment
      - HOST=0.0.0.0
      - PORT=5000
      - FLASK_DEBUG=False
      - UPLOAD_FOLDER=/app/data/uploads
      - TEMP_FOLDER=/app/data/temp
      - OUTPUT_FOLDER=/app/data/output
      - LOG_DIR=/app/logs
    
    # Port mapping
    ports:
      - "${HOST_PORT:-8080}:5000"
    
    # Volume mapping for data persistence
    volumes:
      # Data persistence
      - ./data:/app/data
      # Log persistence
      - ./logs:/app/logs
      # Optional: Custom configuration
      - ./.env:/app/.env:ro
    
    # Resource limits
    deploy:
      resources:
        limits:
          memory: 4G
          cpus: '2.0'
        reservations:
          memory: 1G
          cpus: '0.5'
    
    # Health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    
    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# Optional: Add a reverse proxy for production
  nginx:
    image: nginx:alpine
    container_name: mini-video-factory-nginx
    restart: unless-stopped
    
    ports:
      - "${NGINX_PORT:-80}:80"
      - "${NGINX_SSL_PORT:-443}:443"
    
    volumes:
      - ./docker/nginx.conf:/etc/nginx/nginx.conf:ro
      # Optional: SSL certificates
      # - ./ssl:/etc/nginx/ssl:ro
    
    depends_on:
      - mini-video-factory
    
    # Only start nginx if explicitly enabled
    profiles:
      - production

# Networks
networks:
  default:
    name: mini-video-factory-network

# Volumes for data persistence
volumes:
  app_data:
    driver: local
  app_logs:
    driver: local